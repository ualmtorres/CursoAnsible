<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5.dev">
<meta name="author" content="Cloud-DI Team - Departamento de Informática. UAL">
<title>Ansible. Automatización de operaciones</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Ansible. Automatización de operaciones</h1>
<div class="details">
<span id="author" class="author">Cloud-DI Team - Departamento de Informática. UAL</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#trueresumen">Resumen</a></li>
<li><a href="#truequ-es-ansible">1. Qué es Ansible</a></li>
<li><a href="#trueventajas-de-ansible">2. Ventajas de Ansible</a></li>
<li><a href="#truerequisitos-de-ansible">3. Requisitos de Ansible</a>
<ul class="sectlevel2">
<li><a href="#truerequisitos-para-la-m-quina-de-control">3.1. Requisitos para la máquina de control</a></li>
<li><a href="#truerequisitos-de-los-nodos-administrados">3.2. Requisitos de los nodos administrados</a></li>
</ul>
</li>
<li><a href="#trueinstalaci-n-de-ansible">4. Instalación de Ansible</a>
<ul class="sectlevel2">
<li><a href="#trueconfiguraci-n-de-la-m-quina-de-control">4.1. Configuración de la máquina de control</a></li>
<li><a href="#trueconfiguraci-n-de-las-m-quinas-administradas">4.2. Configuración de las máquinas administradas</a></li>
<li><a href="#truecopia-de-claves-ssh-a-m-quinas-administradas">4.3. Copia de claves SSH a máquinas administradas</a></li>
</ul>
</li>
<li><a href="#truearchivos-de-configuraci-n-y-de-inventario">5. Archivos de configuración y de inventario</a></li>
<li><a href="#truecomandos-directos">6. Comandos directos</a>
<ul class="sectlevel2">
<li><a href="#trueejecuci-n-de-comandos-como-code-root-code">6.1. Ejecución de comandos como <code>root</code></a></li>
</ul>
</li>
<li><a href="#trueplaybooks-para-operaciones-sencillas">7. Playbooks para operaciones sencillas</a>
<ul class="sectlevel2">
<li><a href="#truepar-metros-de-inter-s-para-ejecuci-n-de-playbooks">7.1. Parámetros de interés para ejecución de playbooks</a></li>
<li><a href="#truemodificaci-n-de-archivos-con-code-blockinfile-code">7.2. Modificación de archivos con <code>blockinfile</code></a></li>
<li><a href="#trueuso-de-em-templates-em-para-creaci-n-de-archivos-personalizados">7.3. Uso de <em>templates</em> para creación de archivos personalizados</a></li>
<li><a href="#truemodificaci-n-de-archivos-con-code-lineinfile-code">7.4. Modificación de archivos con <code>lineinfile</code></a></li>
<li><a href="#truegesti-n-de-repositorios-code-apt-code">7.5. Gestión de repositorios <code>APT</code></a></li>
<li><a href="#trueinstalaci-n-de-paquetes">7.6. Instalación de paquetes</a></li>
<li><a href="#trueejecuci-n-de-comandos-en-m-quinas-administradas">7.7. Ejecución de comandos en máquinas administradas</a></li>
<li><a href="#truemanejo-de-archivos">7.8. Manejo de archivos</a></li>
<li><a href="#truereiniciar-servicios">7.9. Reiniciar servicios</a></li>
<li><a href="#truereiniciar-una-bater-a-de-servidores">7.10. Reiniciar una batería de servidores</a></li>
<li><a href="#truedescarga-condicional-de-archivos">7.11. Descarga condicional de archivos</a></li>
</ul>
</li>
<li><a href="#trueorganizaci-n-b-sica-de-proyectos-ansible">8. Organización básica de proyectos Ansible</a></li>
<li><a href="#truecreaci-n-de-un-playbook-para-el-despliegue-de-una-aplicaci-n-php-desde-un-repositorio-github">9. Creación de un playbook para el despliegue de una aplicación PHP desde un repositorio GitHub</a></li>
<li><a href="#trueansible-galaxy">10. Ansible Galaxy</a>
<ul class="sectlevel2">
<li><a href="#trueinstalaci-n-de-un-rol-de-ansible-galaxy">10.1. Instalación de un rol de Ansible Galaxy</a></li>
<li><a href="#truecreaci-n-de-un-rol-con-ansible-galaxy">10.2. Creación de un rol con Ansible Galaxy</a></li>
<li><a href="#trueorganizaci-n-de-playbooks-y-roles">10.3. Organización de playbooks y roles</a></li>
</ul>
</li>
<li><a href="#trueplaybook-para-inicializar-una-base-de-datos-mysql">11. Playbook para inicializar una base de datos MySQL</a>
<ul class="sectlevel2">
<li><a href="#trueinstalaci-n-de-mysql">11.1. Instalación de MySQL</a></li>
<li><a href="#truecreaci-n-de-la-bd">11.2. Creación de la BD</a></li>
<li><a href="#truea-adir-una-aplicaci-n-php-a-la-base-de-datos-sg">11.3. Añadir una aplicación PHP a la base de datos SG</a></li>
</ul>
</li>
<li><a href="#trueyaml">Anexo A: YAML</a>
<ul class="sectlevel2">
<li><a href="#trueinicio-de-un-documento-yaml">A.1. Inicio de un documento YAML</a></li>
<li><a href="#trueescalares">A.2. Escalares</a></li>
<li><a href="#truelistas">A.3. Listas</a></li>
<li><a href="#truemapas">A.4. Mapas</a></li>
<li><a href="#trueliterales">A.5. Literales</a></li>
</ul>
</li>
<li><a href="#trueobtener-informaci-n-de-los-nodos-administrados">Anexo B: Obtener información de los nodos administrados</a></li>
<li><a href="#trueuso-de-variables">Anexo C: Uso de variables</a>
<ul class="sectlevel2">
<li><a href="#truedefinici-n-de-variables-para-playbooks">C.1. Definición de variables para playbooks</a></li>
<li><a href="#truedefinici-n-de-variables-en-archivos">C.2. Definición de variables en archivos</a></li>
<li><a href="#truedefinici-n-local-de-variables">C.3. Definición local de variables</a></li>
<li><a href="#truepaso-de-variables-en-la-l-nea-de-comandos">C.4. Paso de variables en la línea de comandos</a></li>
<li><a href="#truepetici-n-de-variables-en-la-ejecuci-n">C.5. Petición de variables en la ejecución</a></li>
<li><a href="#trueiteraci-n-sobre-variables">C.6. Iteración sobre variables</a></li>
</ul>
</li>
<li><a href="#truetareas-ad-hoc-habituales">Anexo D: Tareas ad-hoc habituales</a>
<ul class="sectlevel2">
<li><a href="#truereiniciar-servidores">D.1. Reiniciar servidores</a></li>
</ul>
</li>
<li><a href="#trueadministraci-n-de-openstack">Anexo E: Administración de OpenStack</a>
<ul class="sectlevel2">
<li><a href="#trueconfiguraci-n-del-nodo-de-control-de-ansible">E.1. Configuración del nodo de control de Ansible</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/di.png" alt="di.png">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueresumen"><a class="anchor" href="#trueresumen"></a>Resumen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La configuración y el aprovisionamiento de sistemas es un proceso que conviene automatizar, especialmente cuando nos enfrentamos a la administración de una gran cantidad de equipos. Además, normalmente se trata de procesos repetitivos y farragosos en los que es muy posibile la introducción de errores. En este sentido, las herramientas de automatización de sistemas y gestión de la configuración nos asisten en estas tareas.</p>
</div>
<div class="paragraph">
<p>Ansible es una herramienta de automatización y gestión de la configuración. Con Ansible podremos gestionar decenas, cientos o miles de sistemas de forma sencilla, y además desde cualquier lugar. Su arquitectura basada en módulos permite extender sus capacidades casi de forma indefinida. Encontramos módulos para cloud (Amazon, Azure, Google, OpenStack, &#8230;&#8203;), virtualización (VMware, oVirt), bases de datos, archivos, monitorización, red, almancenamiento, control de versiones, Windows, &#8230;&#8203;). Además, su configuración es sencilla, lo que permite tener todo preparado para un proyecto de Ansible con rapidez. La configuración de Ansible sólo exige la instalacion de Python en cada uno de los equipos a administrar. El equipo que orquesta o gestiona la configuración tendrá instalado Python y Ansible.</p>
</div>
<div class="paragraph">
<p>En este seminario haremos una introducción al uso de Ansible mediante ejemplos cotidianos, trabajando con algunos de los módulos más habituales y presentando Ansible Galaxy para aumentar la productividad en nuestros proyectos.</p>
</div>
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>Conocer las ventajas y la potencia que aporta Ansible en la automatización de operaciones y gestión de la configuración.</p>
</li>
<li>
<p>Aprender a usar roles y playbooks para la automatización de operaciones.</p>
</li>
<li>
<p>Conocer los módulos básicos de Ansible.</p>
</li>
<li>
<p>Usar Ansible Galaxy para la creación de playbooks.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truequ-es-ansible"><a class="anchor" href="#truequ-es-ansible"></a>1. Qué es Ansible</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ansible es una herramienta que permite la administración remota y de sistemas mediante código. Con Ansible podremos crear <em>recetas</em> para la creación de infraestructura, aprovisionamiento de recursos y despliegue de aplicaciones.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="NOTA"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La Gestión de la configuración es una forma de gestión de cambios en un sistema siguiendo un método que permita mantener su integridad en el tiempo. Se registran y documentan las operaciones realizadas de forma que es posible saber cuándo y por qué se llevó a cabo un cambio. Además, permite saber el estado exacto de un sistema en un momento determinado.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La creación y administración de infraestrucutra como código, combinada con un sistema de control de versiones nos permite el trabajo en equipo, la prueba de configuraciones, vuelta atrás a configuraciones anteriores, y otras ventajas del uso de sistemas de control de versiones.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueventajas-de-ansible"><a class="anchor" href="#trueventajas-de-ansible"></a>2. Ventajas de Ansible</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>No necesita agentes</p>
</li>
<li>
<p>Sólo requiere que esté instalado Python en las máquinas a administrar</p>
</li>
<li>
<p>Uso de módulos para enriquecer su funcionalidad y facilitar su uso</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truerequisitos-de-ansible"><a class="anchor" href="#truerequisitos-de-ansible"></a>3. Requisitos de Ansible</h2>
<div class="sectionbody">
<div class="paragraph">
<p>De forma predeterminada, Ansible administra máquinas mediante el protocolo SSH. Sólo es necesario tener instalado Ansible en una máquina (la máquina de control), que es la que puede administrar baterías de máquinas remotas de forma centralizada. En las máquinas remotas sólo hace falta que esté instalado Python.</p>
</div>
<div class="sect2">
<h3 id="truerequisitos-para-la-m-quina-de-control"><a class="anchor" href="#truerequisitos-para-la-m-quina-de-control"></a>3.1. Requisitos para la máquina de control</h3>
<div class="paragraph">
<p>Actualmente Ansible puede ejecutarse desde cualquier máquina con Python 2 (versión 2.7) o Python 3 (versiones 3.5 y posteriores). La máquina de control no puede ser una máquina Windows.</p>
</div>
</div>
<div class="sect2">
<h3 id="truerequisitos-de-los-nodos-administrados"><a class="anchor" href="#truerequisitos-de-los-nodos-administrados"></a>3.2. Requisitos de los nodos administrados</h3>
<div class="paragraph">
<p>Necesitamos una forma de comunicarnos con los nodos gestionados, y se suele hacer mediante SSH. También se necesita Python 2 (versión 2.7) o Python 3 (versiones 3.5 y posteriores)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="NOTA"></i>
</td>
<td class="content">
<div class="paragraph">
<p>De forma predeterminada, Ansible usa el intérprete Python localizado en  <code>/usr/bin/python</code> para ejecutar sus módulos. Sin embargo, algunas distribuciones de Linux sólo tienen un intérprete de Python 3 de forma predetermianda (<code>/usr/bin/python3</code>). En esos sistemas puede producirse un error como este:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>"module_stdout": "/bin/sh: /usr/bin/python: No such file or directory\r\n"
you can either set the ansible_python_interpreter inventory variable (see Working with Inventory) to point at your interpreter or you can install a Python 2 interpreter for modules to use. You will still need to set ansible_python_interpreter if the Python 2 interpreter is not installed to /usr/bin/python.</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueinstalaci-n-de-ansible"><a class="anchor" href="#trueinstalaci-n-de-ansible"></a>4. Instalación de Ansible</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="trueconfiguraci-n-de-la-m-quina-de-control"><a class="anchor" href="#trueconfiguraci-n-de-la-m-quina-de-control"></a>4.1. Configuración de la máquina de control</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instalación de Python</p>
<div class="paragraph">
<p>Comenzaremos instalando Python. En nuestro caso instalaremos Python 2.7.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ sudo apt-get update
$ sudo apt-get install -y python-minimal</code></pre>
</div>
</div>
</li>
<li>
<p>Instalación de Ansible</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ sudo apt-get update
$ sudo apt-get install software-properties-common
$ sudo apt-add-repository --yes --update ppa:ansible/ansible
$ sudo apt-get install ansible</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="CONSEJO"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si estamos usando OpenStack, podemos pasar en el proceso de creación de la instancia que actúa como máquina de control de Ansible el script de instalación de Python y Ansible. De esta forma, una vez creada la instancia, ya estará preparada para para actuar como máquina de control Ansible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>#!/bin/bash

echo "Instalando Python"
apt-get update
apt-get install -y python-minimal

echo "Instalando Ansible"
apt-get install -y software-properties-common
apt-add-repository --yes --update ppa:ansible/ansible
apt-get install -y ansible</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras la instalación podemos probar que Python y Ansible están funcionando correctamente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ python --version
Python 2.7.12

$ ansible --version
ansible 2.7.5
  config file = /etc/ansible/ansible.cfg
  configured module search path = [u'/home/ubuntu/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python2.7/dist-packages/ansible
  executable location = /usr/bin/ansible
  python version = 2.7.12 (default, Nov 12 2018, 14:36:49) [GCC 5.4.0 20160609]</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguraci-n-de-las-m-quinas-administradas"><a class="anchor" href="#trueconfiguraci-n-de-las-m-quinas-administradas"></a>4.2. Configuración de las máquinas administradas</h3>
<div class="paragraph">
<p>En las máquinas administradas basta con instalar Python.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ sudo apt-get update
$ sudo apt-get install -y python-minimal</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="CONSEJO"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si estamos usando OpenStack, podemos pasar en el proceso de creación de las instancias que actúan como máquinas administradas por Ansible el script de instalación de Python. De esta forma, una vez creadas las instancias, ya estarán preparadas para para actuar como máquinas administradas por Ansible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>#!/bin/bash

echo "Instalando Python"
apt-get update
apt-get install -y python-minimal</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truecopia-de-claves-ssh-a-m-quinas-administradas"><a class="anchor" href="#truecopia-de-claves-ssh-a-m-quinas-administradas"></a>4.3. Copia de claves SSH a máquinas administradas</h3>
<div class="paragraph">
<p>La comunicación entre la máquina de control y las administradas es vía SSH. Por tanto, la máquina de control deberá tener la clave privada y las máquinas administradas la clave pública (examinar el archivo <code>~/.ssh/authorized_keys</code> de las máquinas administradas para ver las claves públicas autorizadas).</p>
</div>
<div class="paragraph">
<p>Para ello, copiaremos la clave desde la máquina de control hasta las máquinas administradas con <code>ssh-copy-id</code>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">ssh-copy-id -i ~/.ssh/id_rsa 20.0.0.27
ssh-copy-id -i ~/.ssh/id_rsa 20.0.0.22</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="NOTA"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si hemos creado las instancias de Ansible en OpenStack, dichas instancias ya se habrán creado con una clave pública inyectada. Sólo los clientes en los que esté su pareja de clave privada podrán iniciar sesión en dichas instancias.</p>
</div>
<div class="paragraph">
<p>Podemos crear un par de claves para la ocasión y distribuirla desde la máquina de control de Ansible a las máquinas remotas. Otra opción es copiar a la máquina de control Ansible la clave privada que empareja con la clave pública que ya tienen inyectada las instancias</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truearchivos-de-configuraci-n-y-de-inventario"><a class="anchor" href="#truearchivos-de-configuraci-n-y-de-inventario"></a>5. Archivos de configuración y de inventario</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En la instalación de Ansible se crea un archivo de configuración global (<code>/etc/ansible/ansible.cfg</code>) y un archivo de inventario global (<code>/etc/ansible/hosts</code>). Sin embargo, preferimos usar archivos de configuración y de inventario a nivel de cada proyecto Ansible. Esto permite usar diferentes configuraciones e inventarios en función del proyecto.</p>
</div>
<div class="paragraph">
<p>El archivo de inventario contiene la lista de máquinas a administrar. Cada máquina aparecerá en una línea y es posible crear grupos de máquinas para lanzar posteriormente scripts Ansible a grupos de máquinas.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 1. Ejemplo de archivo de inventario <code>hosts.cfg</code> usando grupos</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"># Inventory hosts.cfg file

[controller]
10.0.0.51

[network]
10.0.0.52

[compute]
10.0.0.53
10.0.0.54
10.0.0.55
10.0.0.56

[block]
10.0.0.51

[shared]
10.0.0.63

[object]
10.0.0.61
10.0.0.62</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A modo de ejemplo podemos crear una carpeta de trabajo (p.e. <code>cursostic</code>). En esa carpeta guardaremos todos nuestros archivos. Comenzaremos guardando el archivo de configuración (<code>ansible.cfg</code>) y el de inventario (<code>hosts.cfg</code>). En el archivo de inventario colocaremos las máquinas a administrar</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 2. Archivo de configuración local <code>ansible.cfg</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">[defaults]

inventory      = ./hosts.cfg <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Usar el archivo de inventario situado en la misma carpeta</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 3. Archivo de inventario <code>hosts.cfg</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"># Archivo hosts.cfg de inventario
20.0.1.11
20.0.1.4</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Prueba de funcionamiento</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible all -m ping

20.0.1.11 | SUCCESS =&gt; {
    "changed": false,
    "ping": "pong"
}
20.0.1.4 | SUCCESS =&gt; {
    "changed": false,
    "ping": "pong"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecomandos-directos"><a class="anchor" href="#truecomandos-directos"></a>6. Comandos directos</h2>
<div class="sectionbody">
<div class="exampleblock">
<div class="title">Ejemplo 4. Conocer el uso de disco de las máquinas del inventario</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible all -a "df -h" <i class="conum" data-value="1"></i><b>(1)</b>

20.0.1.11 | CHANGED | rc=0 &gt;&gt;
Filesystem      Size  Used Avail Use% Mounted on
udev            991M     0  991M   0% /dev
tmpfs           201M  3.1M  197M   2% /run
/dev/vda1        20G  2.0G   18G  10% /
tmpfs          1001M     0 1001M   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs          1001M     0 1001M   0% /sys/fs/cgroup
tmpfs           201M     0  201M   0% /run/user/1000

20.0.1.4 | CHANGED | rc=0 &gt;&gt;
Filesystem      Size  Used Avail Use% Mounted on
udev            991M     0  991M   0% /dev
tmpfs           201M  3.1M  197M   2% /run
/dev/vda1        20G  2.0G   18G  10% /
tmpfs          1001M     0 1001M   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs          1001M     0 1001M   0% /sys/fs/cgroup
tmpfs           201M     0  201M   0% /run/user/1000</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>all</code> hace referencia a que se ejecute en todos los equipos del inventario</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueejecuci-n-de-comandos-como-code-root-code"><a class="anchor" href="#trueejecuci-n-de-comandos-como-code-root-code"></a>6.1. Ejecución de comandos como <code>root</code></h3>
<div class="paragraph">
<p>El argumento <code>--become</code> permite ejecutar comandos como <code>root</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 5. Realizar operaciones como <code>root</code> en todos los equipos administrados</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>ansible all -a "apt update" --become <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>--become</code> ejecuta las operaciones como <code>root</code> en los equipos administrados</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 6. Reiniciar todos los equipos del inventario</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible all -a "reboot" --become</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 7. Realizar operaciones en un grupo de equipos administrados</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">ansible webserver -a "apt install apache2" --become <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>webserver</code> indica el grupo de servidores del inventario sobre el que realizar operaciones. Se puede indicar una lista de grupos separados por comas.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Ansible permite el uso de módulos que amplían la funcionalidad básica proporcionada por Ansible. La <a href="https://docs.ansible.com/ansible/latest/modules/modules_by_category.html">página de módulos de Ansible</a> ofrece un acceso al listado de módulos agrupados por categorías.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, el módulo <a href="https://docs.ansible.com/ansible/latest/modules/copy_module.html#copy-module"><code>copy</code></a> copia un archivo del sistema de archivos local al lugar indicado en las máquinas remotas.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 8. Copiar un archivo a las máquinas administradas</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">ansible all -m copy -a "src=sample.txt dest=/home/ubuntu/sample.txt"</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueplaybooks-para-operaciones-sencillas"><a class="anchor" href="#trueplaybooks-para-operaciones-sencillas"></a>7. Playbooks para operaciones sencillas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Antes de pasar a crear proyectos más completos que incluyan varias operaciones agrupadas en roles comencemos por la creación de playbooks con operaciones sencillas. Esto nos permitirá familiarizarnos con las tareas de Ansible.</p>
</div>
<div class="paragraph">
<p>Los playbooks y los roles, que veremos más adelante, se escriben en sintaxis YAML, descrita en el Apéndice <a href="#trueyaml">YAML</a>.</p>
</div>
<div class="paragraph">
<p>En los playbooks seguiremos la esctrucura siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Nombre del Playbook</p>
</li>
<li>
<p>Indicar si queremos recuperar información de los hosts administrados</p>
</li>
<li>
<p>Hosts sobre los que aplicar el playbook</p>
</li>
<li>
<p>Lista de tareas a realizar</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 9. Playbook de ejemplo <code>local.yml</code> para mostrar información local y un mensaje por pantalla</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Basic playbook run locally <i class="conum" data-value="1"></i><b>(1)</b>
  gather_facts: true <i class="conum" data-value="2"></i><b>(2)</b>
  hosts: localhost <i class="conum" data-value="3"></i><b>(3)</b>
  tasks: <i class="conum" data-value="4"></i><b>(4)</b>
    - name: Doing a ping
      ping:

    - name: Show info
      debug:
        msg: "Machine name: {{ ansible_hostname }}"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nombre del playbook</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Obtener información de los hosts de destino. No sería necesario porque es la opción predeterminada</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Hosts sobre los que aplicar las tareas siguientes</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Lista de tareas a ejecutar</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Los playbooks se ejecutan con <code>ansible-playbook</code>, que en su sintaxis más básica ejecuta el playbook que le pasemos como argumento.</p>
</div>
<div class="paragraph">
<p>Para ejecutar el playbook anterior escribiríamos el comando siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-playbook local.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación se muestra el resultado de ejecución del playbook</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">PLAY [Basic playbook run locally] **********************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [Doing a ping] ************************************************************
ok: [localhost]

TASK [Show info] ***************************************************************
ok: [localhost] =&gt; {
    "msg": "Machine name: ansible-control"
}

PLAY RECAP *********************************************************************
localhost                  : ok=3    changed=0    unreachable=0    failed=0</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="NOTA"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En la ejecución de un playbook es posible obtener información de los hosts administrados. Este proceso se conoce como <em>gather facts</em> y de forma predeterminada se obtiene dicha información. El apéndice <a href="#trueobtener-informaci-n-de-los-nodos-administrados">Obtener información de los nodos administrados</a> ofrece información sobre esta funcionalidad.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="truepar-metros-de-inter-s-para-ejecuci-n-de-playbooks"><a class="anchor" href="#truepar-metros-de-inter-s-para-ejecuci-n-de-playbooks"></a>7.1. Parámetros de interés para ejecución de playbooks</h3>
<div class="ulist">
<ul>
<li>
<p><code>-i archivo_de_inventario</code>: Permite usar un archivo de inventario específico</p>
</li>
<li>
<p><code>--start-at-task=tarea_de_inicio</code>: Indica la tarea por la que comenzar a ejecutar el playbook</p>
</li>
<li>
<p><code>--step</code>: Permite ejecutar el playbook paso a paso</p>
</li>
<li>
<p><code>--become</code>: Ejecuta operaciones como <code>root</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El comando siguiente ejecuta paso a paso el playbook <code>mysql.yml</code> como <code>root</code> comenzando por la tarea <code>Update package cache</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-playbook mysql.yml --become --start-at-task "Update package cache" --step</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truemodificaci-n-de-archivos-con-code-blockinfile-code"><a class="anchor" href="#truemodificaci-n-de-archivos-con-code-blockinfile-code"></a>7.2. Modificación de archivos con <code>blockinfile</code></h3>
<div class="paragraph">
<p>El módulo <a href="https://docs.ansible.com/ansible/latest/modules/blockinfile_module.html?highlight=blockinfile"><code>blockinfile</code></a> inserta, actualiza o elimina un bloque de líneas en un archivo. El texto modificado queda delemitado por líneas que actúan como marcador.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 10. Playbook <code>blockinfile.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Blockinfile to edit files
  gather_facts: false
  hosts: all
  tasks:
    - name: "Adding Ansible manager and managed nodes to /etc/hosts"
      blockinfile:
        name: /etc/hosts <i class="conum" data-value="1"></i><b>(1)</b>
        block: | <i class="conum" data-value="2"></i><b>(2)</b>
          # Manager
          20.0.1.7 manager

          # Managed-1
          20.0.1.11 managed-1

          # Managed-2
          20.0.1.4 managed-2
        marker: "# {mark} ANSIBLE MANAGED BLOCK manager and managed nodes" <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Archivo a modificar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bloque de texto a incluir</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Texto para delimitar el bloque de texto añadido</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>La ejecución la haremos con <code>ansible-playbook</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-playbook blockinfile.yml --become

PLAY [Blockinfile to edit files] ***********************************************

TASK [Adding Ansible manager and managed nodes to /etc/hosts] ******************
changed: [20.0.1.4]
changed: [20.0.1.11]

PLAY RECAP *********************************************************************
20.0.1.11                  : ok=1    changed=1    unreachable=0    failed=0
20.0.1.4                   : ok=1    changed=1    unreachable=0    failed=0</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="NOTA"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Dado que Ansible es idempotente, la ejecución repetida del playbook no añadirá nuevos bloques en cada ejecución. La ejecución de un playbook de Ansible debe entenderse como <em>este el estado deseado para las máquinas administradas</em>. Una modificación sobre los valores del playbook supondría un cambio y al volver a ejecutar el playbook se trasladaría la modificación a las máquinas gestionadas.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación se muestra un extracto del archivo <code>/etc/hosts</code> en las máquinas administradas como resultado de ejecutar el playbook anterior.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">127.0.0.1 localhost

....

# BEGIN ANSIBLE MANAGED BLOCK manager and managed nodes <i class="conum" data-value="1"></i><b>(1)</b>
# Manager <i class="conum" data-value="2"></i><b>(2)</b>
20.0.1.7 manager

# Managed-1
20.0.1.11 managed-1

# Managed-2
20.0.1.4 managed-2
# END ANSIBLE MANAGED BLOCK manager and managed nodes <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inicio del texto delimitador del bloque</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Texto introducido</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Fin del texto delimitador del bloque</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="trueuso-de-un-archivo-de-variables-para-los-playbooks"><a class="anchor" href="#trueuso-de-un-archivo-de-variables-para-los-playbooks"></a>7.2.1. Uso de un archivo de variables para los playbooks</h4>
<div class="paragraph">
<p>Las variables definidas en <code>group_vars/all.yml</code> serán visibles para todos los playbooks del mismo directorio sin necesidad de indicar o incluir nada.</p>
</div>
<div class="paragraph">
<p>Como ejemplo, vamos a definir un archivo de variables <code>group_vars/all.yml</code> con el nombre y la dirección IP de un conjuntos de máquinas.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 11. El archivo <code>group_vars/all.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">manager: { name: manager, ip: 20.0.1.7 }
managed_1: { name: managed-1, ip: 20.0.1.11 }
managed_2: { name: managed-2, ip: 20.0.1.4 }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Veamos ahora una revisión del ejemplo del playbook anterior usando variables.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 12. Playbook de <code>blockinfile</code> usando variables</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Blockinfile to edit files
  gather_facts: false
  hosts: all
  tasks:
    - name: "Adding Ansible manager and managed nodes to /etc/hosts"
      blockinfile:
        name: /etc/hosts
        block: |
          # Manager
          {{ manager.ip }} {{ manager.name }} <i class="conum" data-value="1"></i><b>(1)</b>

          # Managed-1
          {{ managed_1.ip }} {{ managed_1.name }} <i class="conum" data-value="2"></i><b>(2)</b>

          # Managed-2
          {{ managed_2.ip }} {{ managed_2.name }} <i class="conum" data-value="3"></i><b>(3)</b>
        marker: "# {mark} ANSIBLE MANAGED BLOCK manager and managed nodes"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Variables para la IP y nombre del nodo <code>manager</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Variables para la IP y nombre del nodo <code>managed-1</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Variables para la IP y nombre del nodo <code>managed-2</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="NOTA"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El apéndice <a href="#trueuso-de-variables">Uso de variables</a> contiene información sobre la forma y los distintos lugares donde se pueden definir variables en Ansible. También se muestra cómo pedir variables en el momento de la ejecución y como iterar sobre ellas.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueuso-de-em-templates-em-para-creaci-n-de-archivos-personalizados"><a class="anchor" href="#trueuso-de-em-templates-em-para-creaci-n-de-archivos-personalizados"></a>7.3. Uso de <em>templates</em> para creación de archivos personalizados</h3>
<div class="paragraph">
<p>Con <a href="https://docs.ansible.com/ansible/latest/modules/template_module.html?highlight=template"><code>template</code></a> podemos incluir archivos en los nodos administrados sustituyendo previamente las variables que incluyan por sus valores correspondientes.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 13. El archivo <em>template</em> de base <code>sample-template.txt</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Ejemplo de archivo personsalizado usando templates:

El nodo {{ manager.name }} tiene la IP: {{ manager.ip }}.
El nodo {{ managed_1.name }} tiene la IP: {{ managed_1.ip }}.
El nodo {{ managed_2.name }} tiene la IP: {{ managed_2.ip }}.</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 14. Playbook <code>template.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Template to customize files
  gather_facts: false
  hosts: all
  tasks:
    - name: "Creating customized sample-template.txt in /home/ubuntu/sample-template.txt"
      template: &gt;
        src=/home/ubuntu/cursostic/sample-template.txt
        dest=/home/ubuntu/sample-template.txt
        owner=ubuntu
        group=ubuntu
        mode=0644</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>El resultado en los nodos administrados:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Ejemplo de archivo personsalizado usando templates:

El nodo manager tiene la IP: 20.0.1.7.
El nodo managed-1 tiene la IP: 20.0.1.11.
El nodo managed-2 tiene la IP: 20.0.1.4.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truemodificaci-n-de-archivos-con-code-lineinfile-code"><a class="anchor" href="#truemodificaci-n-de-archivos-con-code-lineinfile-code"></a>7.4. Modificación de archivos con <code>lineinfile</code></h3>
<div class="paragraph">
<p>El módulo <a href="https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html?highlight=lineinfile"><code>lineinfile</code></a> asegura que exista una línea con un texto concreto en un archivo. Para la búsqueda se usan <a href="https://docs.python.org/2/library/re.html">expresiones regulares</a>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, cuando el nombre de la máquina no está en el archivo <code>/etc/hosts/</code> aparece un mensaje molesto como el siguiente en la línea de comandos cuando cambiamos al modo superusuario con <code>sudo su -</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">sudo: unable to resolve host ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para solucionarlo basta con añadir <code>127.0.0.1</code> seguido del nombre de la máquina al archivo <code>/etc/hosts</code>. A continuación veremos cómo localizar la entrada <code>127.0.0.1 localhost</code> en el archivo e introducir una línea a continuación para solucionar el molesto mensaje.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 15. El playbook <code>lineinfile.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Lineinfile to edit files
  hosts: all
  tasks:
    - name: "Adding hostname to /etc/hosts"
      lineinfile:
        path: /etc/hosts <i class="conum" data-value="1"></i><b>(1)</b>
        insertafter: '^127\.0\.0\.1' <i class="conum" data-value="2"></i><b>(2)</b>
        line: 127.0.0.1 {{ ansible_hostname }} <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Archivo a modificar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Buscar la última línea que comienza por <code>127.0.0.1</code> para insertar una línea a continuación (<code>insertafter</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Insertar la linea con <code>127.0.0.1</code> y el nombre de la máquina, obtenido en el proceso de <code>Gathering facts</code> y disponible en la variable <code>ansible_hostname</code></td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truegesti-n-de-repositorios-code-apt-code"><a class="anchor" href="#truegesti-n-de-repositorios-code-apt-code"></a>7.5. Gestión de repositorios <code>APT</code></h3>
<div class="paragraph">
<p>El módulo <a href="https://docs.ansible.com/ansible/latest/modules/apt_repository_module.html?highlight=apt_repository"><code>apt_repository</code></a> permite añadir o eliminar repositorios <code>APT</code> en distribuciones Ubuntu y Debian.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 16. El playbook <code>apt_repository.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: apt_repository to manage APT repositories
  gather_facts: false
  hosts: all
  tasks:
    - name: "Add APT OpenStack repository for Ubuntu Xenial"
      apt_repository:
        repo: "deb http://ubuntu-cloud.archive.canonical.com/ubuntu xenial-updates/ocata main"</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Tras ejecutar el playbook podemos comprobar que las máquinas de destino tienen el repositorio disponible mostrando el contenido del archivo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">/etc/apt/sources.list.d/ubuntu_cloud_archive_canonical_com_ubuntu.list</code></pre>
</div>
</div>
<div class="paragraph">
<p>El resultado será:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">deb http://ubuntu-cloud.archive.canonical.com/ubuntu xenial-updates/ocata main</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para eliminar un repositorio se usaría el parámetro <code>state: absent</code> de <code>apt_repository</code></p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 17. El playbook <code>remove-apt_repository.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: apt_repository to manage APT repositories
  gather_facts: false
  hosts: all
  tasks:
    - name: "Add APT OpenStack repository for Ubuntu Xenial"
      apt_repository:
        repo: "deb http://ubuntu-cloud.archive.canonical.com/ubuntu xenial-updates/ocata main"
      state: absent</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Tras ejecutar el playbook podemos comprobar que las máquinas de destino ya no tienen el repositorio disponible y que no existe el archivo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">/etc/apt/sources.list.d/ubuntu_cloud_archive_canonical_com_ubuntu.list</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueinstalaci-n-de-paquetes"><a class="anchor" href="#trueinstalaci-n-de-paquetes"></a>7.6. Instalación de paquetes</h3>
<div class="paragraph">
<p>El módulo <a href="https://docs.ansible.com/ansible/latest/modules/apt_module.html?highlight=apt"><code>apt</code></a> se encarga de la gestión de paquetes en Ubuntu y Debian. Cuando queremos instalar una lista de paquetes definiremos la lista de paquetes y normalmente lo haremos con una variable</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 18. El playbook <code>apt.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Blockinfile to edit files
  gather_facts: false
  hosts: all
  vars: <i class="conum" data-value="1"></i><b>(1)</b>
    packages:
      - mysql-server
      - phpmyadmin

  tasks:
    - name: Install packages old style with explicit list
      apt:
        name: "{{ item }}" <i class="conum" data-value="2"></i><b>(2)</b>
      with_items: <i class="conum" data-value="3"></i><b>(3)</b>
        - mysql-server
        - phpmyadmin

    - name: Install packages old style using variables
      apt:
        name: "{{ item }}"
      with_items:
        - "{{ packages }}" <i class="conum" data-value="4"></i><b>(4)</b>


    - name: Install packages new style with explicit list
      apt:
        name: ['mysql-server', 'phpmyadmin'] <i class="conum" data-value="5"></i><b>(5)</b>

    - name: Install packages new style using variables
      apt:
        name: "{{ packages }}" <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Definición de variables en el propio playbook</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>{{ item }}</code> representa la variable de iteración de un bucle <code>with_items</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Especificación de un bucle</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Uso de una variable para suministrar los valores sobre los que iterar</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Sintaxis compacta especificando una lista en lugar de usar un bucle</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Sintaxis compacta usando una variable que proporciona los elementos de iteración</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Para eliminar paquetes usamos el parámetro <code>state: absent</code> en <code>apt</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 19. Playbook para eliminar un paquete (<code>remove-apt.yml</code>)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Remove apt packages
  gather_facts: false
  hosts: all

  tasks:
    - name: Removing phpmyadmin
      apt:
        name: phpmyadmin
        state: absent</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueejecuci-n-de-comandos-en-m-quinas-administradas"><a class="anchor" href="#trueejecuci-n-de-comandos-en-m-quinas-administradas"></a>7.7. Ejecución de comandos en máquinas administradas</h3>
<div class="paragraph">
<p>El módulo <a href="https://docs.ansible.com/ansible/latest/modules/shell_module.html?highlight=shell"><code>shell</code></a> toma un comando como argumento y lo ejecuta en la máquina remota.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 20. Playbook <code>shell.yml</code> para copia de un archivo</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Run commands with shell
  hosts: all

  tasks:
    - name: Copy sample-template.txt to sample-template.bak
      shell: 'cp sample-template.txt sample-template.bak' <i class="conum" data-value="1"></i><b>(1)</b>
      args:
        chdir: /home/ubuntu <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Comando a ejecutar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Directorio sobre el que ejecutar el comando</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truemanejo-de-archivos"><a class="anchor" href="#truemanejo-de-archivos"></a>7.8. Manejo de archivos</h3>
<div class="paragraph">
<p>El módulo <a href="https://docs.ansible.com/ansible/latest/modules/file_module.html?highlight=file"><code>file</code></a> permite configurar atributos de archivos y directorios. También permite la creación y eliminación de archivos.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 21. Playbook para gestión de archivos <code>file.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Run file commands
  hosts: all
  gather_facts: false

  tasks:
    - name: Create a directory
      file: <i class="conum" data-value="1"></i><b>(1)</b>
        path: /home/ubuntu/myfolder
        state: directory
        owner: ubuntu
        group: ubuntu

    - name: Delete sample-template.bak file
      file:
        path: /home/ubuntu/sample-template.bak
        state: absent <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creación de un directorio y modificación del propietario</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Eliminar el archivo</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truereiniciar-servicios"><a class="anchor" href="#truereiniciar-servicios"></a>7.9. Reiniciar servicios</h3>
<div class="paragraph">
<p>El módulo <a href="https://docs.ansible.com/ansible/latest/modules/service_module.html?highlight=service"><code>service</code></a> permite la administración de servicios en nodos remotos.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 22. Playbook para el reinicio de servicios <code>services.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Restart services
  hosts: all
  gather_facts: false

  tasks:
    - name: Restart MySQL and Apache
      service:
        name: "{{ item }}" <i class="conum" data-value="1"></i><b>(1)</b>
        state: restarted
      with_items: <i class="conum" data-value="2"></i><b>(2)</b>
        - mysql
        - apache2</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Elemento del bucle sobre el que se está iterando</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Lista de servicios sobre los que iterar</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truereiniciar-una-bater-a-de-servidores"><a class="anchor" href="#truereiniciar-una-bater-a-de-servidores"></a>7.10. Reiniciar una batería de servidores</h3>
<div class="paragraph">
<p>Podemos usar el módulo <code>shell</code> para lanzar un <code>reboot</code> sobre los nodos adninistrados. Además, podemos combinar esta operación con el módulo <a href="https://docs.ansible.com/ansible/latest/modules/wait_for_connection_module.html?highlight=wait_for_connection">wait_for_connection</a> que espera la cantidad de segundos que le indiquemos. Una vez recuperada la conexión dentro de ese periodo, continúa la ejecución del playbook.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 23. Playbook <code>reboot-and-wait.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Reboot and wait
  hosts: all

  tasks:
    - name: Rebooting
      shell: sleep 2 &amp;&amp; reboot
      async: 1
      poll: 0

    - name: Waiting for rebooting
      wait_for_connection:
        delay: 15
        sleep: 10
        timeout: 300

    - debug:
        msg: "{{ inventory_hostname }} is up and running"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truedescarga-condicional-de-archivos"><a class="anchor" href="#truedescarga-condicional-de-archivos"></a>7.11. Descarga condicional de archivos</h3>
<div class="paragraph">
<p>El módulo <a href="https://docs.ansible.com/ansible/latest/modules/fetch_module.html"><code>fetch</code></a> permite la descarga de archivos de las máquinas gestionadas al nodo manager.</p>
</div>
<div class="paragraph">
<p>Podemos combinar este módulo con la ejecución condicional que permite por ejemplo descargar el archivo sólo si la máquina remota tiene cierto nombre. La cláusula <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html?highlight=when#the-when-statement"><code>when</code></a> permite la evaluación de expresiones.</p>
</div>
<div class="paragraph">
<p>A modo de ejemplo, usaremos los hechos (<em>facts</em>) recuperados de las máquinas remotas para obtener su nombre y ejecutar la tarea de descarga de archivos sólo si el nombre coincide con el que buscamos.</p>
</div>
<div class="paragraph">
<p>Otro uso podría ser la instalación de paquetes con <code>yum</code> o <code>apt</code> en función de si la distribución es de la familia (<code>ansible_facts['os_family']</code>) Red Hat o Debian, respectivamente.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 24. Playbook para descarga condicional de archivos <code>conditions.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Get remote files
  hosts: all

  tasks:
    - name: Get remote file checking conditions
      fetch:
        src: /etc/hosts
        dest: /home/ubuntu/hosts-from-managed-1
        flat: yes <i class="conum" data-value="1"></i><b>(1)</b>
      when:
        ansible_facts['hostname'] == "ansible-managed-1" <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Descarga el archivo sin añadir el nombre de la máquina y la ruta completa del archivo. El comportamiento predeterminado descargaría el archivo en <code>/home/ubuntu/hosts-from-managed-1/20.0.1.11/etc/hosts</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La tarea sólo se ejecuta en aquellos hosts cuyo <code>hostname</code> sea el indicado</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueorganizaci-n-b-sica-de-proyectos-ansible"><a class="anchor" href="#trueorganizaci-n-b-sica-de-proyectos-ansible"></a>8. Organización básica de proyectos Ansible</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En un modo de funcionamiento normal de Ansible las tareas no suelen estar directamente en los playbooks. En cambio, se suelen organizar las tareas en roles, y los playbooks incluirán una lista de roles a ejecutar, junto con los hosts a los que van dirigidos.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 25. Ejemplo de playbook basado en roles</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">- hosts: all <i class="conum" data-value="1"></i><b>(1)</b>
  become: true
  roles: <i class="conum" data-value="2"></i><b>(2)</b>
    - basic

- hosts: controller
  become: true
  roles:
    - ntp_server

- hosts: all:!controller <i class="conum" data-value="3"></i><b>(3)</b>
  become: true
  roles:
    - ntp_others

- hosts: all
  become: true
  roles:
    - openstack_packages

- hosts: controller
  become: true
  roles:
    - sql_database
    - rabbitmq
    - memcached</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hosts sobre los que se ejecutarán los roles indicados.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Lista de roles a ejecutar sobre los hosts indicados</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ejecutar en todos los hosts excepto <code>controller</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Los roles se definen en carpetas <strong>que le dan nombre al rol</strong>. Además, los roles se crean de acuerdo a una estructura de subcarpetas establecida, que es la siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tasks</code>: Incluye el archivo <code>main.yml</code> con la lista de tareas a ejecutar. La ejecución de una tarea puede desencadenar la ejecución de acciones (p.e. reiniciar un servicio tras modificar un archivo de configuración). La tarea <em>notifica</em> una acción pendiente. Las acciones notificadas se ejecutarán tras finalizar todas las tareas del rol.</p>
</li>
<li>
<p><code>handlers</code>: Incluye el archivo <code>main.yml</code> con la lista de acciones paras las notificaciones pendientes.</p>
</li>
<li>
<p><code>templates</code>: Incluye las plantillas de archivos que se desplegarán en las máquinas remotas previa sustitución de variables. Los archivos se colocarán en una estructura de carpetas similar a la que tendrán en el host de destino tomando como raíz la carpeta <code>handlers</code>. Por ejemplo, una plantilla para personalizar los hosts en las máquinas de destino se colocaría en <code>handlers/etc/hosts</code>, ya que en las máquinas de destino se coloca en (<code>/etc/hosts</code>).</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 26. Ejemplo de organización de un rol</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">ntp_server/
├── handlers
│   └── main.yml
├── tasks
│   └── main.yml
└── templates
    └── etc
        └── chrony
            └── chrony.conf</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="CONSEJO"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cuando vamos a crear un rol, podemos crear la carpeta del rol y la estructura de subcarpetas con un solo comando. El comando siguiente crearía la carpeta para el rol <code>ntp_server</code> y las subcarpetas para <code>handlers</code>, tareas y <code>templates</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ mkdir -p ntp_server/{handlers,tasks,templates}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Un proyecto Ansible se organizaría de esta forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">├── ansible.cfg <i class="conum" data-value="1"></i><b>(1)</b>
├── group_vars <i class="conum" data-value="2"></i><b>(2)</b>
│   └── all.yml
├── hosts.cfg <i class="conum" data-value="3"></i><b>(3)</b>
├── playbook-1.yml <i class="conum" data-value="4"></i><b>(4)</b>
├── playbook-2.yml
├── ...
├── roles <i class="conum" data-value="5"></i><b>(5)</b>
│   ├── barbican
│   │   ├── handlers
│   │   │   └── main.yml
│   │   ├── tasks
│   │   │   └── main.yml
│   │   └── templates
│   │       └── etc
│   │           └── barbican
│   │               ├── barbican-api-paste.ini
│   │               └── barbican.conf
│   ├── ...
│   ├── heat
│   │   ├── handlers
│   │   │   └── main.yml
│   │   ├── tasks
│   │   │   └── main.yml
│   │   └── templates
│   │       └── etc
│   │           └── heat
│   │               └── heat.conf
│   ├── ...
└── site.yml <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Archivo de configuración del proyecto (p.e. para indicar el archivo de inventario)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Variables accesibles a todos los playbooks</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Archivo de inventario de hosts</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Playbooks del proyecto</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Roles del proyecto</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Playbook opcional que contiene la llamada a todos los playbooks del proyecto</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="CONSEJO"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si un proyecto Ansible contiene gran cantidad de playbooks, es conveniente crear un nuevo playbook que se encargue de llamarlos a todos. Esto se realiza en Ansible mediante <code>include</code></p>
</div>
<div class="paragraph">
<p>Por ejemplo, <code>site.yml</code> contiene la llamada a todos los playbooks que realizan un despliegue complejo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">- include: playbook-basic.yml
- include: playbook-keystone.yml
- include: playbook-glance.yml
- include: playbook-nova.yml
- include: playbook-neutron.yml
...</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 27. Ejemplo de <code>tasks/main.yml</code> con las tareas de un rol</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">- name: Install chrony
  apt:
    name: chrony
    state: latest

- name: Setup chrony on controller
  template: &gt; <i class="conum" data-value="1"></i><b>(1)</b>
    src=etc/chrony/chrony.conf
    dest=/etc/chrony/chrony.conf
    owner=root
    group=root
    mode=0644
  notify: restart chrony <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso de un archivo <em>template</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Notificación de ejecución de una acción al finalizar el rol</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 28. Ejemplo de <em>template</em> <code>templates/etc/chrony/chrony.conf</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">pool 2.debian.pool.ntp.org offline iburst

server {{ntp_server}} iburst <i class="conum" data-value="1"></i><b>(1)</b>
allow {{management_network}}/24

keyfile /etc/chrony/chrony.keys
commandkey 1
driftfile /var/lib/chrony/chrony.drift
log tracking measurements statistics
logdir /var/log/chrony
maxupdateskew 100.0
dumponexit
dumpdir /var/lib/chrony
logchange 0.5
hwclockfile /etc/adjtime
rtcsync</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso de variables. El archivo se creará en los servidores de destino con los valores asignados a las variables (p.e. <code>ntp_server: 1.es.pool.ntp.org</code>)</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 29. Ejemplo de <code>handlers/main.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">- name: restart chrony <i class="conum" data-value="1"></i><b>(1)</b>
  service:
    name: chrony
    state: restarted</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El nombre del <em>handler</em> tiene que corresponder con el indicado en la cláusula <code>notify</code> de la tarea</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreaci-n-de-un-playbook-para-el-despliegue-de-una-aplicaci-n-php-desde-un-repositorio-github"><a class="anchor" href="#truecreaci-n-de-un-playbook-para-el-despliegue-de-una-aplicaci-n-php-desde-un-repositorio-github"></a>9. Creación de un playbook para el despliegue de una aplicación PHP desde un repositorio GitHub</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ansible dispone de un módulo <a href="https://docs.ansible.com/ansible/latest/modules/git_module.html?highlight=git"><code>git</code></a> que permite realizar operaciones <code>git</code> en los equipos administrados. A continuación se muestra un ejemplo de tarea para clonar un repositorio de GitHub en la carpeta <code>/var/www/html/diariostic</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">- name: Clone diariostic repository
  git:
    repo: 'https://github.com/ualmtorres/diariostic.git'
    dest: /var/www/html/diariostic</code></pre>
</div>
</div>
<div class="paragraph">
<p>Veamos un ejemplo de playbook (<code>diariostic.yml</code>) que se ejecutará sobre un equipo al que denominamos <code>diariostic</code>, que estará incluido en el archivo de inventario de hosts. El playbook incluye un rol, denominado <code>diariostic</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 30. Playbook <code>diariostic.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Deploy diariostic PHP application from scratch
  hosts: diariostic
  roles:
    - diariostic</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>El rol <code>diariostic</code> descarga Apache, PHP y el repositorio de aplicación. Además, personaliza Apache para que trabaje sobre el puerto 8080 en lugar de sobre el 80.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 31. Rol <code>diariostic</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Update package cache
  apt:
    update_cache: yes

- name: Install Apache and PHP
  apt:
    name: ['apache2', 'php']

- name: Clone diariostic repository
  git:
    repo: 'https://github.com/ualmtorres/diariostic.git'
    dest: /var/www/html/diariostic

- name: Change port to 8080 in /etc/apache2/ports.conf
  lineinfile:
    path: /etc/apache2/ports.conf
    regexp: '^Listen 80'
    line: 'Listen 8080'

- name: Change port to 8080 in /etc/apache2/sites-enabled/000-default.conf
  lineinfile:
    path: /etc/apache2/sites-enabled/000-default.conf
    regexp: '^&lt;VirtualHost \*:80&gt;'
    line: '&lt;VirtualHost *:8080&gt;'

- name: Restart Apache
  service:
    name: apache2
    state: restarted</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Después de ejecutar el playbook con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-playbook diariostic.yml --become</code></pre>
</div>
</div>
<div class="paragraph">
<p>la aplicación estará disponible en la carpeta <code>diariostic</code> del servidor aprovisionado.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/diariostic.png" alt="diariostic.png">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueansible-galaxy"><a class="anchor" href="#trueansible-galaxy"></a>10. Ansible Galaxy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Los roles son un concepto básico en Ansible. Con objeto de poder reutilizar roles en diferentes playbooks es interesante organizar los roles en carpetas independientes y tener un repositorio para cada uno de ellos.</p>
</div>
<div class="paragraph">
<p>Dada la posibilidad entonces de organizar así los roles se ha organizado una comunidad para la publicación e intercambio de roles denominada <a href="https://galaxy.ansible.com/">Ansible Galaxy</a>. Cada rol en Ansible Galaxy está enlazado a su código fuente.</p>
</div>
<div class="sect2">
<h3 id="trueinstalaci-n-de-un-rol-de-ansible-galaxy"><a class="anchor" href="#trueinstalaci-n-de-un-rol-de-ansible-galaxy"></a>10.1. Instalación de un rol de Ansible Galaxy</h3>
<div class="paragraph">
<p>Es conveniente disponer entonces de una carpeta donde tengamos almacenados todos los roles (p.e. <code>roles</code>). Después, en un nivel superior tendremos los playbooks y los archivos de inventario correspondientes a cada proyecto. Pero quizá sería mejor tener todos los playbooks y archivos de inventario en una carpeta al mismo nivel que los roles. En este caso los playbooks subirían un nivel y luego bajarían por la carpeta <code>roles</code> para usar los roles correspondientes.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 32. Organización de playbooks y roles</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">.
├── playbooks
│   ├── nginx-hosts.cfg
│   ├── nginx-playbook.yml
│   ├── php-hosts.cfg
│   ├── php-playbook.yml
│   ├── phpwebserver-hosts.cfg
│   └── phpwebserver-playbook.yml
└── roles
    ├── geerlingguy.git
    │   ├── ...
    ├── geerlingguy.php
    │   ├── ...
    ├── ualmtorres.apache
    │   ├── ...
    └── ualmtorres.apache2
        ├── ...</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Sea <code>roles</code> la carpeta donde guardamos todos nuestros roles y sea <code>geerlingguy.php</code> el rol que queremos instalar, disponible en Ansible Galaxy. Para descargar e instalar el rol localmente escribiríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-galaxy install geerlingguy.php –p roles</code></pre>
</div>
</div>
<div class="paragraph">
<p>Luego, en nuestra carpeta de playbooks, crearíamos el archivo de inventario de hosts para nuestro proyecto y el del playbook.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 33. El archivo <code>php-hosts.cfg</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">20.0.1.11
20.0.1.4</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 34. El archivo <code>php-playbook.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
- hosts: all
  become: true
  roles:
    - ../roles/geerlingguy.php</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Para ejecutar este playbook desde la carpeta de playbooks basta con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-playbook -i nginx-hosts.cfg nginx-playbook.yml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecreaci-n-de-un-rol-con-ansible-galaxy"><a class="anchor" href="#truecreaci-n-de-un-rol-con-ansible-galaxy"></a>10.2. Creación de un rol con Ansible Galaxy</h3>
<div class="paragraph">
<p>Ansible Galaxy también permite la creación de roles. Esto tiene como ventaja la inicialización de una serie de carpetas y archivos que hará que nuestros roles sigan los estándares establecidos para el desarrollo en Ansible y seguidos por la comunidad de Ansible.</p>
</div>
<div class="paragraph">
<p>Para crear un rol, sobre la carpeta <code>roles</code> ejecutaremos el comando siguiente para crear un rol denominado <code>ualmtorres.apache</code>. Seguiremos como regla de nomenclatura un nombre de usuario (p.e. el nombre de usuario en Ansible Galaxy) seguido de punto (<code>.</code>) y el nombre del rol. Así, podríamos tener varios roles similares, pero de usuarios diferentes y usar cada uno de ellos según corresponda.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-galaxy init ualmtorres.apache</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto creará la estructura siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">ualmtorres.apache
├── defaults <i class="conum" data-value="1"></i><b>(1)</b>
│   └── main.yml
├── files <i class="conum" data-value="2"></i><b>(2)</b>
├── handlers <i class="conum" data-value="3"></i><b>(3)</b>
│   └── main.yml
├── meta <i class="conum" data-value="4"></i><b>(4)</b>
│   └── main.yml
├── README.md <i class="conum" data-value="5"></i><b>(5)</b>
├── tasks <i class="conum" data-value="6"></i><b>(6)</b>
│   └── main.yml
├── templates <i class="conum" data-value="7"></i><b>(7)</b>
├── tests <i class="conum" data-value="8"></i><b>(8)</b>
│   ├── inventory
│   └── test.yml
└── vars <i class="conum" data-value="9"></i><b>(9)</b>
    └── main.yml</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Valores por defecto para varables usadas en el rol. Serán sobrescritas por las definidas en <code>vars</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Archivos requeridos para la ejecución del rol. Estos archivos, a diferencia de los situados en <code>templates</code> no pueden ser mmanipulados.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Carpeta de <em>handlers</em> con las tareas pendientes de ejecución generadas por <code>notify</code> en tareas ya ejecutadas (p.e. reiniciar servicios tras una modificación de la configuración)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Metadatos que usar Ansible Galaxy para publicar el rol (p.e. versión mínima de Ansible, plataformas soportadas, dependencias, &#8230;&#8203;)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Información descriptiva y de uso del rol</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Tareas del rol</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Archivos para procesar en el proceso de despliegue y que se modificarán de acuerdo a las variables que usen</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Casos de prueba para soporte a sistemas de integración continua como Jenkins o Travis</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Variables usadas en el rol. Sobrescriben a las que aparezcan en <code>defaults</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por ejemplo, podemos incluir la tarea siguiente en el archivo <code>tasks/main.yml</code> para asegurar que Apache queda instalado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---
# tasks file for ualmtorres.apache
- name: Install Apache
  apt: name=apache2 state=present</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueorganizaci-n-de-playbooks-y-roles"><a class="anchor" href="#trueorganizaci-n-de-playbooks-y-roles"></a>10.3. Organización de playbooks y roles</h3>
<div class="paragraph">
<p>Con el paso del tiempo, la carpeta <code>roles</code> irá creciendo con los roles usados y desarrollados. Todos ellos serán reutilizados en los distintos proyectos en lo que sean últiles. A continuación se muestra un ejemplo de la organización propuesta para playbooks y roles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">.
├── playbooks <i class="conum" data-value="1"></i><b>(1)</b>
│   ├── nginx-hosts.cfg
│   ├── nginx-playbook.yml
│   ├── php-hosts.cfg
│   ├── php-playbook.yml
│   ├── phpwebserver-hosts.cfg
│   └── phpwebserver-playbook.yml
└── roles <i class="conum" data-value="2"></i><b>(2)</b>
    ├── geerlingguy.git <i class="conum" data-value="3"></i><b>(3)</b>
    │   ├── ...
    ├── geerlingguy.php <i class="conum" data-value="4"></i><b>(4)</b>
    │   ├── ...
    └── ualmtorres.apache <i class="conum" data-value="5"></i><b>(5)</b>
        ├── ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Carpeta para playbooks y arhivos de inventario</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Carpeta para roles</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Rol de instalación de Git</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Rol de instalación de PHP</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Rol propio de instalación de Apache</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora queremos desarrollar un playbook con Apache y PHP que use los roles <code>ualmtorres.apache</code> y <code>geerlingguy.php</code>, bastaría con crear un nuevo playbook como el siguiente</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 35. Playbook <code>phpwebserver-playbook.yml</code> para la instalación de un servidor web Apache y PHP</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
- hosts: all
  become: true
  roles:
    - ../roles/ualmtorres.apache
    - ../roles/geerlingguy.php</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Para ejecutarlo, desde la carpeta de playbooks escribiríamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-playbook -i phpwebserver-hosts.cfg phpwebserver-playbook.yml <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El archivo <code>phpwebserver-hosts.cfg</code> contendría la lista de hosts en la que se desea ejecutar el playbook</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="CONSEJO"></i>
</td>
<td class="content">
<div class="paragraph">
<p>También se podrían sacar los archivos de inventario de la carpeta de playbooks y colocarlos en una carpeta aparte (p.e. <code>inventory</code>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueplaybook-para-inicializar-una-base-de-datos-mysql"><a class="anchor" href="#trueplaybook-para-inicializar-una-base-de-datos-mysql"></a>11. Playbook para inicializar una base de datos MySQL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En este ejemplo veremos cómo inicializar un servidor con MySQL con una base de datos precargada. El servidor MySQL lo instalaremos con un rol de Ansible Galaxy. El script de la base de datos lo descargaremos con una tarea Ansible para la descarga de archivos. La carga la haremos con una tarea Ansible del módulo MySQL para la carga de datos.</p>
</div>
<div class="sect2">
<h3 id="trueinstalaci-n-de-mysql"><a class="anchor" href="#trueinstalaci-n-de-mysql"></a>11.1. Instalación de MySQL</h3>
<div class="paragraph">
<p>Un nivel por encima de nuestra carpeta de roles instalaremos el rol de MySQL de <code>geerlingguy</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-galaxy install geerlingguy.mysql -p roles</code></pre>
</div>
</div>
<div class="paragraph">
<p>El archivo <code>geerlingguy.mysq/defaults/main.yml</code> contiene variables para la personalización de la instalación de MySQL. Cambiaremos los valores de las dos variables que establecen la contraseña del usuarios <code>root</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">...
mysql_user_password: changeme
...
mysql_root_password: changeme
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Crearemos un playbook (<code>mysql.yml</code>) para la instalación del rol</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: MySQL Playbook
  hosts: dbserver
  roles:
    - geerlingguy.mysql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ejecutaremos el playbook</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-playbook mysql.yml --become</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto habrá instalado MySQL en el host <code>dbserver</code>. La contraseña del usuario <code>root</code> será <code>changeme</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="truecreaci-n-de-la-bd"><a class="anchor" href="#truecreaci-n-de-la-bd"></a>11.2. Creación de la BD</h3>
<div class="paragraph">
<p>La creación de la base de datos la haremos en dos pasos. Primero descargaremos a la máquina administrada el script que contiene el código de inicialización de la base de datos. Después, importaremos el script descargado a la base de datos.</p>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 36. Rol (<code>crearbdSG</code>) para descargar el script SQL e importarlo a la base de datos</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Download SG.sql
  get_url: <i class="conum" data-value="1"></i><b>(1)</b>
    url: https://raw.githubusercontent.com/ualmtorres/docker_customer_catalog/master/init.sql
    dest: /home/ubuntu/SG.sql

- name: Import SG database
  mysql_db: <i class="conum" data-value="2"></i><b>(2)</b>
    name: SG
    state: import
    target: /home/ubuntu/SG.sql <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Descargar el archivo indicado en la ruta especificada en <code>dest</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>El módulo <code>mysql_db</code> permite la creación y eliminación de bases de datos, así como operaciones de importación y exportación</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ruta de la máquina remota en la que se encuentra el archivo a importar</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>A continuación, modificaremos el playbook anterior (<code>mysql.yml</code>) para añadir el nuevo rol</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: MySQL Playbook
  hosts: dbserver
  roles:
    - geerlingguy.mysql
    - crearbdSG <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nuevo rol añadido para la carga de datos</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="CONSEJO"></i>
</td>
<td class="content">
<div class="paragraph">
<p>No es necesario ejecutar el playbook completo desde el principio. Podemos indicar que se comience a ejecutar a partir de una tarea determinada con el parámetro <code>start-at-task</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-playbook mysql.yml --become --start-at-task "Download SG.sql"</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truea-adir-una-aplicaci-n-php-a-la-base-de-datos-sg"><a class="anchor" href="#truea-adir-una-aplicaci-n-php-a-la-base-de-datos-sg"></a>11.3. Añadir una aplicación PHP a la base de datos SG</h3>
<div class="paragraph">
<p>A continuacion podríamos crear otro playbook para añadir al host anterior un servidor Apache y un intérprete PHP. Como ejemplo, podríamos descargar un <a href="https://raw.githubusercontent.com/ualmtorres/CustomerCatalog/master/index.php">script PHP que muestra el listado de clientes de la base de datos SG</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="NOTA"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El script está configurado sólo para una prueba de concepto y usa la cuenta de <code>root</code> y la contraseña en el mismo código. La base de datos se denomina <code>SG</code>, y se accede a través de la cuenta <code>root</code> y con la contraseña <code>changeme</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">---

- name: Update package cache
  apt:
    update_cache: yes

- name: Install Apache and PHP
  apt:
    name: ['apache2', 'php', 'libapache2-mod-php', 'php-mysql']

- name: Restart Apache
  service:
    name: apache2
    state: restarted

- name: Download customer_catalog
  get_url:
    url: https://raw.githubusercontent.com/ualmtorres/CustomerCatalog/master/index.php
    dest: /var/www/html/index.php</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueyaml"><a class="anchor" href="#trueyaml"></a>Anexo A: YAML</h2>
<div class="sectionbody">
<div class="paragraph">
<p>YAML es un lenguaje de serialización de datos legible. Permite definir tipos de datos comunes, como listas, mapas y valores escalares.</p>
</div>
<div class="paragraph">
<p>YAML es sensible a los espacios en blanco y usa indentación para el anidado de datos.</p>
</div>
<div class="sect2">
<h3 id="trueinicio-de-un-documento-yaml"><a class="anchor" href="#trueinicio-de-un-documento-yaml"></a>A.1. Inicio de un documento YAML</h3>
<div class="paragraph">
<p>Es posible añadir dos directivas al inicio de los documentos YAML (<code>%YAML</code> y <code>%TAG</code>), aunque en la práctica no se suelen usar.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>%YAML</code>: Especifica la versión YAML del documento</p>
</li>
<li>
<p><code>%TAG</code>: Define un <em>tag</em>. Los <em>tags</em> se usan para definir tipos de datos en documentos YAML.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Después de las dos directivas se añade una línea con tres guiones (<code>---</code>) para marcar el inicio del documento YAML. La mayoría de los documentos YAML comienzan directamente con los tres guiones (<code>---</code>) ignorando el uso de las directivas <code>%YAML</code> y <code>%TAG</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="trueescalares"><a class="anchor" href="#trueescalares"></a>A.2. Escalares</h3>
<div class="paragraph">
<p>Usaremos valores escalares para cadenas y números</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
name: Michael
power_level: 9001</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truelistas"><a class="anchor" href="#truelistas"></a>A.3. Listas</h3>
<div class="paragraph">
<p>Podemos definir listas de dos formas: En un listado por líneas en el que cada item aparecerá indentando y con un guión, o bien de forma compacta separando los items por comas y encerrando los elementos de la lista entre corchetes</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
ansible_statements:
- Easy to learn
- Powerful
- Extensive module support</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
ansible_statements: [Easy to learn, Powerful, Extensive module support]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truemapas"><a class="anchor" href="#truemapas"></a>A.4. Mapas</h3>
<div class="paragraph">
<p>Un mapa permite definir pares clave&#8594;valor. También son conocidos como arrays asociativos o <code>hashmaps</code>. Anteriormente ya usamos un mapa</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
name: Michael
power_level: 9001</code></pre>
</div>
</div>
<div class="paragraph">
<p>El mapa es el todo, que está formado por pares clave&#8594;valor. De forma compacta, podemos expresar el mapa anterior como:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
{ name: Michael, power_level: 9001 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero podemos definir estructuras más complejas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
person:
    first_name: Michael
    last_name: Heap
    skills: <i class="conum" data-value="1"></i><b>(1)</b>
        - Ansible
        - Golang
        - Python
        - PHP
    likes: [dogs, walking, programming] <i class="conum" data-value="2"></i><b>(2)</b>
    favorites: <i class="conum" data-value="3"></i><b>(3)</b>
        drink: Pepsi Max
        color: Red
    other: <i class="conum" data-value="4"></i><b>(4)</b>
        - key: value <i class="conum" data-value="5"></i><b>(5)</b>
          another: val
        - key: foo
          another: bar <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Lista</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Lista compacta</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mapa</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Mapa de listas</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Mapa</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Mapa</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueliterales"><a class="anchor" href="#trueliterales"></a>A.5. Literales</h3>
<div class="paragraph">
<p>Permiten definir cadenas largas</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>message: &gt;
    This is a message that is
    going to span several lines
    but is going to be placed on
    a single line when evaluated</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si usamos el operador <em>pipe</em> (<code>|</code>) respetará los saltos de línea definidos en el literal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>message: |
    This is a message that is
    going to span several lines
    whilst keeping whitespace
    intact</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueobtener-informaci-n-de-los-nodos-administrados"><a class="anchor" href="#trueobtener-informaci-n-de-los-nodos-administrados"></a>Anexo B: Obtener información de los nodos administrados</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Al lanzar la ejecución de un playbook se ejecuta una tarea que recopila información sobre los hosts sobre los que se lanza el playbook. Entre esta información se encuentra información del procesador, red, fecha y hora, variables de entorno y gran cantidad de información de los sistemas remotos.</p>
</div>
<div class="paragraph">
<p>El comando siguiente muestra la información que se recupera de los hosts remotos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible all -m setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para acceder a la información recopilada usaremos la variable <code>hostvars</code>. El ejemplo siguiente muestra la recuperación de la dirección IP de una interfaz de red de un equipo remoto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>hostvars['myserver.com']['ansible_ens3']['ipv4']['address']</code></pre>
</div>
</div>
<div class="paragraph">
<p>También se puede usar la notación punto (<code>.</code>) para navegar por los distintos elementos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>hostvars['20.0.1.4'].ansible_ens3.ipv4.address</code></pre>
</div>
</div>
<div class="paragraph">
<p>También podemos usar <code>ansible_facts</code> para acceder a información de los hosts remotos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
- hosts: all
  tasks:
    - debug: msg="Nombre {{ ansible_facts.nodename }} Procesador {{ ansible_facts.processor }}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para desactivar la recopilación de información de los sistemas remotos añadiremos <code>gather_facts: false</code> al playbook. Esto hará que la ejecución sea más rápida en aquellos casos en que no necesitemos obtener información sobre los sistemas remotos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
- hosts: all
  gather_facts: false <i class="conum" data-value="1"></i><b>(1)</b>
  vars_prompt:
    - name: your_name
      prompt: "What is your name?"
  tasks:
    - debug: msg="Hello {{your_name}}"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Desactivación de recopilación de información de hosts remotos</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueuso-de-variables"><a class="anchor" href="#trueuso-de-variables"></a>Anexo C: Uso de variables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Las variables en Ansible son gestionadas por el motor de plantillas <a href="http://jinja.pocoo.org/">Jinja2</a>. Jinja2 propociona sustitución de variables usando la sintaxis de doble llave <code>{{ variable }}</code>.</p>
</div>
<div class="paragraph">
<p>En Ansible se pueden definir variables a varios niveles, cada uno con un nivel de prioridad. Las variables definidas en variables con mayor nivel de prioridad sobrescriben los valores definidos en lugares con mayor nivel de prioridad.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Niveles de prioridad crecientes de variables en Ansible</div>
<div class="ulist">
<ul>
<li>
<p>command line values (eg “-u user”)</p>
</li>
<li>
<p>role defaults</p>
</li>
<li>
<p>inventory file or script group vars</p>
</li>
<li>
<p>inventory group_vars/all</p>
</li>
<li>
<p>playbook group_vars/all</p>
</li>
<li>
<p>inventory group_vars/*</p>
</li>
<li>
<p>playbook group_vars/*</p>
</li>
<li>
<p>inventory file or script host vars</p>
</li>
<li>
<p>inventory host_vars/*</p>
</li>
<li>
<p>playbook host_vars/*</p>
</li>
<li>
<p>host facts / cached set_facts</p>
</li>
<li>
<p>play vars</p>
</li>
<li>
<p>play vars_prompt</p>
</li>
<li>
<p>play vars_files</p>
</li>
<li>
<p>role vars (defined in role/vars/main.yml)</p>
</li>
<li>
<p>block vars (only for tasks in block)</p>
</li>
<li>
<p>task vars (only for the task)</p>
</li>
<li>
<p>include_vars</p>
</li>
<li>
<p>set_facts / registered vars</p>
</li>
<li>
<p>role (and include_role) params</p>
</li>
<li>
<p>include params</p>
</li>
<li>
<p>extra vars (always win precedence)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truedefinici-n-de-variables-para-playbooks"><a class="anchor" href="#truedefinici-n-de-variables-para-playbooks"></a>C.1. Definición de variables para playbooks</h3>
<div class="paragraph">
<p>En <code>group_vars/all.yml</code> estableceremos las variables que queremos que sean comunes a todos los playbooks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>nodes_by_name:
    controller: {name: testcontroller, type: controller, management_ip: 10.0.0.51, tunnel_ip: 10.0.1.51, provider_ip: 192.168.64.18}
    network: {name: testnetwork, type: network, management_ip: 10.0.0.52, tunnel_ip: 10.0.1.52, provider_ip: 192.168.64.19}
    compute01: {name: testcompute01, type: compute, management_ip: 10.0.0.53, tunnel_ip: 10.0.1.53}
    compute02: {name: testcompute02, type: compute, management_ip: 10.0.0.54, tunnel_ip: 10.0.1.54}
    compute03: {name: testcompute03, type: compute, management_ip: 10.0.0.55, tunnel_ip: 10.0.1.55}
    compute04: {name: testcompute04, type: compute, management_ip: 10.0.0.56, tunnel_ip: 10.0.1.56}
    block: {name: testcontroller, type: block, management_ip: 10.0.0.51, tunnel_ip: 10.0.1.51}
    object01: {name: testobject01, type: object, management_ip: 10.0.0.61, tunnel_ip: 10.0.1.61}
    object02: {name: testobject02, type: object, management_ip: 10.0.0.62, tunnel_ip: 10.0.1.62}
    shared: {name: testshared, type: shared, management_ip: 10.0.0.63, tunnel_ip: 10.0.1.63, provider_ip: 10.0.0.63}</code></pre>
</div>
</div>
<div class="paragraph">
<p>En las tareas o en las plantillas de archivos podremos acceder a estos valores posteriormente con la notacion punto (<code>.</code>). Como las variables están definidas en <code>group_vars/all.yml</code> no tendremos que indicar nada para poder acceder a sus valores.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>{{ nodes_by_name.controller.management_ip }}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truedefinici-n-de-variables-en-archivos"><a class="anchor" href="#truedefinici-n-de-variables-en-archivos"></a>C.2. Definición de variables en archivos</h3>
<div class="exampleblock">
<div class="title">Ejemplo 37. Archivo <code>variables.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
username: johndoe
fullname: John Doe</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 38. Archivo <code>playbook-variables-en-archivo.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
- hosts: all
  vars_files:
    - variables.yml
  tasks:
    - debug: msg="Username {{ username }}"
    - debug: msg="Nombre completo {{ fullname }}"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truedefinici-n-local-de-variables"><a class="anchor" href="#truedefinici-n-local-de-variables"></a>C.3. Definición local de variables</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
- hosts: all
  vars:
    username: johndoe
    fullname: John Doe
  tasks:
    - debug: msg="Username {{ username }}
    - debug: msg="Nombre completo {{ fullname }}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truepaso-de-variables-en-la-l-nea-de-comandos"><a class="anchor" href="#truepaso-de-variables-en-la-l-nea-de-comandos"></a>C.4. Paso de variables en la línea de comandos</h3>
<div class="paragraph">
<p>Usaremos el parámetro <code>--extra-vars</code> o <code>-e</code> para pasar la lista de pares variable valor la línea de comandos. Esta opción sobrescribirá cualquier valor asignado previamente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible-playbook playbook-variables-en-archivo.yml -e 'username=mtorres fullname="Manuel Torres"'</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="NOTA"></i>
</td>
<td class="content">
<div class="paragraph">
<p>De forma predeterminada los valores son pasados como cadenas. Si necesitamos pasar valores númericos, booleanos, listas u otro tipo, las variables se deben pasar como JSON</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>$  ansible-playbook playbook-variables-en-archivo.yml -e '{"username":"mtorres", "fullname":"Manuel Torres"}'</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truepetici-n-de-variables-en-la-ejecuci-n"><a class="anchor" href="#truepetici-n-de-variables-en-la-ejecuci-n"></a>C.5. Petición de variables en la ejecución</h3>
<div class="exampleblock">
<div class="title">Ejemplo 39. Ejemplo de petición de petición de variables en la ejecución</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
- hosts: all
  vars_prompt:
    - name: your_name
      prompt: "What is your name?"
  tasks:
    - debug: msg="Hello {{your_name}}"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueiteraci-n-sobre-variables"><a class="anchor" href="#trueiteraci-n-sobre-variables"></a>C.6. Iteración sobre variables</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
- hosts: all
  become: true
  vars_files:
    - utilities.yml <i class="conum" data-value="1"></i><b>(1)</b>
  tasks:
    - name: Instalar utilidades
      apt:
        name: "{{ utilities }}" <i class="conum" data-value="2"></i><b>(2)</b>
        state: present</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Archivo que contiene la lista de paquetes a instalar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Variable con la lista de paquetes a instalar</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Iteración en versiones anteriores de Ansible</div>
<div class="paragraph">
<p>En versiones anteriores de Ansible, el recorrido de la lista de paquetes anterior se habría hecho iterando sobre la lista con una construcción `with_items_.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
- hosts: all
  become: true
  vars_files:
    - utilities.yml
  tasks:
    - name: Instalar utilidades
      apt:
        name: "{{ item }}" <i class="conum" data-value="1"></i><b>(1)</b>
        state: present
      with_items: "{{ utilities }}" <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>{{ item }} es la forma usada para iterar sobre la variable indicada en `with_items</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>with_items</code> indica la variable sobre la que iterar</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truetareas-ad-hoc-habituales"><a class="anchor" href="#truetareas-ad-hoc-habituales"></a>Anexo D: Tareas ad-hoc habituales</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="truereiniciar-servidores"><a class="anchor" href="#truereiniciar-servidores"></a>D.1. Reiniciar servidores</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ansible all -a "reboot" --become</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueadministraci-n-de-openstack"><a class="anchor" href="#trueadministraci-n-de-openstack"></a>Anexo E: Administración de OpenStack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Con Ansible podemos automatizar la creación de proyectos y usuarios, así como su configuración inicial. Esto nos ayuda en la tediosa tarea de configuración de la red del proyecto, el router de conexión a la red externa, cuotas, otros usuarios del proyecto, y demás.</p>
</div>
<div class="paragraph">
<p>Ansible dispone de gran cantidad de <a href="https://docs.ansible.com/ansible/latest/modules/list_of_cloud_modules.html#openstack">módulos de interacción con OpenStack</a>. Para poder usar estos módulos tendremos que pasar los parámetros de conexión del administrador a través de variables o usando un archivo que guarde los datos de conexión.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="NOTA"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si optamos por usar un archivo para la conexión, el archivo se almacena en <code>/etc/openstack/clouds.yaml</code> en la máquina de control de OpenStack. Allí, crearemos entradas dentro del elemento <code>clouds:</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 40. Archivo <code>/etc/openstack/clouds.yaml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">clouds:
  openstacktest: <i class="conum" data-value="1"></i><b>(1)</b>
    auth:
      auth_url: http://myopenstack.com:35357/v3 <i class="conum" data-value="2"></i><b>(2)</b>
      username: admin
      password: changeme <i class="conum" data-value="3"></i><b>(3)</b>
      project_name: admin
      user_domain_name: Default
      project_domain_name: Default
    identity_api_version: "3"
    image_api_version: "2"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nombre que usaremos en los scripts Ansible para referirnos a esta conexión</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Endpoint de autenticación</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Contraseña del administrador</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Usaremos un archivo de variables para configurar varios valores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Datos de red de los proyectos creados, como red externa, CIDR de las redes creadas y DNS.</p>
</li>
<li>
<p>Quotas</p>
</li>
<li>
<p>Datos de proyecto y usuario (nombre de proyecto, login, password, nombre completo, email y si se aplica o no la cuota indicada -si no se aplica la cuota indicada se aplicará la cuota predeterminada).</p>
</li>
<li>
<p>Otros usuarios miembros de los proyectos. Esto es útil para introducir supervisores en los proyectos creados (p.e. los profesores de una asignatura serán incluidos en los proyectos de cada alumno).</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 41. Archivo <code>vars/users.yml</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">network: "ext-net"
cidr: 30.0.0.0/24
dns:
  - 150.214.156.2
  - 8.8.8.8

#Para la cuota predetermianda, poner state a absent
quota: {
  state: present,
  instances: 10,
  cores: 20,
  ram: 324800,
  gigabytes: 60,
  backups: 0,
  backup_gigabytes: 0,
  floatingip: 10,
  gigabytes_lvm: 60,
  snapshots: 0,
  snapshots_lvm: 0,
  volumes: 2,
  volumes_lvm: 2
}

watchers:
  - {username: "michael.jackson", role: "user"}
  - {username: "patty.smith", role: "user"}

projects:
  - {project: "jsantamaria", user: "Juan Santamaría", email: "jsantamaria@nothing.com", password: "changeme", quota: "present"} <i class="conum" data-value="1"></i><b>(1)</b>
  - {project: "jgarcia", user: "Josefa García", email: "jgarcia@nothing.es", password: "changeme", quota: "present"}
  - {project: "pgomez", user: "Pedro Gómez", email: "pgomez@norhing.es", password: "changeme", quota: "absent"} <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Con <code>quota: present</code> indicamos que se aplican las cuotas configuradas al proyecto</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Con <code>quota: absent</code> indicamos que no se aplican las cuotas configuradas al proyecto. Se aplicarán las cuotas predeterminadas</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Ejemplo 42. Rol <code>setup-new-project</code> para la creación y configuración de proyectos y usuarios</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">- name: Include var file
  include_vars:
    file: users.yml

- name: Create a project
  os_project:
    cloud=openstacktest <i class="conum" data-value="1"></i><b>(1)</b>
    state=present
    name={{ item.project }}
    description="Proyecto de {{ item.user }}"
    enabled=True
    domain=default
  with_items:
    - "{{ projects }}"

- name: Create the user for the project
  os_user:
    cloud=openstacktest
    state=present
    name={{ item.project }}
    password={{ item.password }}
    description={{ item.user }}
    update_password=on_create
    email={{ item.email }}
    default_project={{ item.project }}
    domain=default
  with_items:
    - "{{ projects }}"

- name: Grant user role on user in the project
  os_user_role:
    cloud=openstacktest
    user={{ item.project }}
    role=user
    project={{ item.project }}
  with_items:
    - "{{ projects }}"

- name: Grant watchers to the projects
  os_user_role:
    cloud: openstacktest
    project: "{{ item[0].project }}"
    user: "{{ item[1].username }}"
    role: "{{ item[1].role }}"
  with_nested:
    - "{{ projects }}"
    - "{{ watchers }}"
  ignore_errors: True

- name: Create the network of the project
  os_network:
    cloud=openstacktest
    state=present
    name="{{ item.project }}-net"
    project={{ item.project }}
  with_items:
    - "{{ projects }}"

- name: Create the subnet
  os_subnet:
    cloud=openstacktest
    state=present
    network_name="{{ item.project }}-net"
    name="{{ item.project }}-subnet"
    cidr={{ cidr }}
    dns_nameservers={{ dns }}
    project={{ item.project }}
  with_items:
    - "{{ projects }}"

- name: Create the router connecting the network and the subnet
  os_router:
    cloud=openstacktest
    state=present
    name="{{ item.project }}-router"
    network={{ network }}
    interfaces="{{ item.project }}-subnet"
    project={{ item.project }}
  with_items:
    - "{{ projects }}"

- name: Apply quotas
  os_quota:
    cloud: openstacktest
    name: "{{ item.project }}"
    instances: " {{ quota.instances}} "
    cores: " {{ quota.cores}} "
    ram: " {{ quota.ram }} "
    gigabytes: " {{ quota.gigabytes }} "
    backups: " {{ quota.backups }} "
    backup_gigabytes: " {{ quota.backup_gigabytes }} "
    floatingip: " {{ quota.floatingip }} "
    gigabytes_types:
      gigabytes_lvm: " {{ quota.gigabytes_lvm }} "
    snapshots: " {{ quota.snapshots }} "
    snapshots_types:
      snapshots_lvm: " {{ quota.snapshots_lvm }} "
    volumes: " {{ quota.volumes}} "
    volumes_types:
      volumes_lvm: " {{ quota.volumes_lvm }} "
  with_items:
    - "{{ projects }}"
  when: item.quota == "present"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Referencia al elemento de credenciales del archivo <code>/etc/openstack/clouds.yaml</code> en el nodo de control de OpenStack</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguraci-n-del-nodo-de-control-de-ansible"><a class="anchor" href="#trueconfiguraci-n-del-nodo-de-control-de-ansible"></a>E.1. Configuración del nodo de control de Ansible</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">export LC_ALL=C
The root cause is: your environment variable LC_ALL is missing or invalid somehow
If you keep getting the error in new terminal windows, add it at the bottom of your .bashrc file.

sudo apt-get install python-shade
sudo apt-get install python-pip
sudo pip install openstacksdk

Si se producen errores:
sudo rm -rf /usr/lib/python2.7/dist-packages/OpenSSL
sudo  rm -rf /usr/lib/python2.7/dist-packages/pyOpenSSL-0.15.1.egg-info
sudo pip install pyopenssl</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-02-18 20:32:21 CET
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>